<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>storefrontapp documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css" media="(prefers-color-scheme: dark)">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">storefrontapp documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content class">
                   <div class="content-data">











<ol class="breadcrumb">
  <li>Classes</li>
  <li >OptimizedSsrEngine</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts</code>
        </p>


            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>The rendered pages are kept in memory to be served on next request. If the <code>cache</code> is set to <code>false</code>, the
response is evicted as soon as the first successful response is successfully returned.</p>

            </p>




            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Protected</span>
                                <a href="#currentConcurrency" >currentConcurrency</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#renderCallbacks" >renderCallbacks</a>
                            </li>
                            <li>
                                    <span class="modifier">Protected</span>
                                <a href="#renderingCache" >renderingCache</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#templateCache" >templateCache</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Protected</span>
                                <a href="#fallbackToCsr" >fallbackToCsr</a>
                            </li>
                            <li>
                                    <span class="modifier">Protected</span>
                                <a href="#getDocument" >getDocument</a>
                            </li>
                            <li>
                                    <span class="modifier">Protected</span>
                                <a href="#getRenderingKey" >getRenderingKey</a>
                            </li>
                            <li>
                                    <span class="modifier">Protected</span>
                                <a href="#getRenderingStrategy" >getRenderingStrategy</a>
                            </li>
                            <li>
                                    <span class="modifier">Protected</span>
                                <a href="#getTimeout" >getTimeout</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#handleRender" >handleRender</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#isConcurrencyLimitExceeded" >isConcurrencyLimitExceeded</a>
                            </li>
                            <li>
                                    <span class="modifier">Protected</span>
                                <a href="#log" >log</a>
                            </li>
                            <li>
                                    <span class="modifier">Protected</span>
                                <a href="#renderResponse" >renderResponse</a>
                            </li>
                            <li>
                                    <span class="modifier">Protected</span>
                                <a href="#returnCachedRender" >returnCachedRender</a>
                            </li>
                            <li>
                                    <span class="modifier">Protected</span>
                                <a href="#shouldRender" >shouldRender</a>
                            </li>
                            <li>
                                    <span class="modifier">Protected</span>
                                <a href="#shouldTimeout" >shouldTimeout</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#startRender" >startRender</a>
                            </li>
                        </ul>
                    </td>
                </tr>





                    <tr>
                        <td class="col-md-4">
                            <h6><b>Accessors</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                    <a href="#engineInstance" >engineInstance</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
        </tbody>
    </table>
</section>

            <section>
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(expressEngine: <a href="../undefineds/NgExpressEngineInstance.html" target="_self">NgExpressEngineInstance</a>, ssrOptions?: <a href="../interfaces/SsrOptimizationOptions.html" target="_self">SsrOptimizationOptions</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="57" class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:57</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>expressEngine</td>
                                                  
                                                        <td>
                                                                        <code><a href="../miscellaneous/typealiases.html#NgExpressEngineInstance" target="_self" >NgExpressEngineInstance</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>ssrOptions</td>
                                                  
                                                        <td>
                                                                        <code><a href="../interfaces/SsrOptimizationOptions.html" target="_self" >SsrOptimizationOptions</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            Yes
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section>
    
    <h3 id="inputs">
        Properties
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="currentConcurrency"></a>
                    <span class="name">
                            <span class="modifier">Protected</span>
                        <span ><b>currentConcurrency</b></span>
                        <a href="#currentConcurrency"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>0</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="39" class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:39</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="renderCallbacks"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>renderCallbacks</b></span>
                        <a href="#renderCallbacks"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>new Map&lt;string, SsrCallbackFn[]&gt;()</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="53" class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:53</a></div>
                        </td>
                    </tr>

            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>When the config <code>reuseCurrentRendering</code> is enabled, we want perform
only one render for one rendering key and reuse the html result
for all the pending requests for the same rendering key.
Therefore we need to store the callbacks for all the pending requests
and invoke them with the html after the render completes.</p>
<p>This Map should be used only when <code>reuseCurrentRendering</code> config is enabled.
It&#39;s indexed by the rendering keys.</p>
</div>
                </td>
            </tr>

        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="renderingCache"></a>
                    <span class="name">
                            <span class="modifier">Protected</span>
                        <span ><b>renderingCache</b></span>
                        <a href="#renderingCache"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>new RenderingCache(this.ssrOptions)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="40" class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:40</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="templateCache"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>templateCache</b></span>
                        <a href="#templateCache"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>new Map&lt;string, string&gt;()</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="41" class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:41</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
</section>

            <section>
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="fallbackToCsr"></a>
                    <span class="name">
                        <span class="modifier">Protected</span>
                        <span ><b>fallbackToCsr</b></span>
                        <a href="#fallbackToCsr"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>fallbackToCsr(response: Response, filePath: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, callback: <a href="../undefineds/SsrCallbackFn.html" target="_self">SsrCallbackFn</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="69"
                            class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:69</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>When SSR page can not be returned in time, we&#39;re returning index.html of
the CSR application.
The CSR application is returned with the &quot;Cache-Control: no-store&quot; response-header. This notifies external cache systems to not use the CSR application for the subsequent request.</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>response</td>
                                    <td>
                                            <code>Response</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>filePath</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>callback</td>
                                    <td>
                                                <code><a href="../miscellaneous/typealiases.html#SsrCallbackFn" target="_self" >SsrCallbackFn</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getDocument"></a>
                    <span class="name">
                        <span class="modifier">Protected</span>
                        <span ><b>getDocument</b></span>
                        <a href="#getDocument"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getDocument(filePath: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="276"
                            class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:276</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Retrieve the document from the cache or the filesystem</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>filePath</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getRenderingKey"></a>
                    <span class="name">
                        <span class="modifier">Protected</span>
                        <span ><b>getRenderingKey</b></span>
                        <a href="#getRenderingKey"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getRenderingKey(request: Request)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="78"
                            class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:78</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>request</td>
                                    <td>
                                            <code>Request</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getRenderingStrategy"></a>
                    <span class="name">
                        <span class="modifier">Protected</span>
                        <span ><b>getRenderingStrategy</b></span>
                        <a href="#getRenderingStrategy"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getRenderingStrategy(request: Request)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="84"
                            class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:84</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>request</td>
                                    <td>
                                            <code>Request</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="../miscellaneous/enumerations.html#RenderingStrategy" target="_self" >RenderingStrategy</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getTimeout"></a>
                    <span class="name">
                        <span class="modifier">Protected</span>
                        <span ><b>getTimeout</b></span>
                        <a href="#getTimeout"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getTimeout(request: Request)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="162"
                            class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:162</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Returns the timeout value.</p>
<p>In case of the rendering strategy ALWAYS_SSR, it returns the config <code>forcedSsrTimeout</code>.
Otherwise, it returns the config <code>timeout</code>.</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>request</td>
                                    <td>
                                            <code>Request</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="handleRender"></a>
                    <span class="name">
                        <span class="modifier">Private</span>
                        <span ><b>handleRender</b></span>
                        <a href="#handleRender"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>handleRender(undefined: literal type)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="296"
                            class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:296</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Delegates the render to the original <em>Angular Universal express engine</em>.</p>
<p>In case when the config <code>reuseCurrentRendering</code> is enabled and <strong>if there is already a pending
render task for the same rendering key</strong>, it doesn&#39;t delegate a new render to Angular Universal.
Instead, it waits for the current rendering to complete and then reuse the result for all waiting requests.</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                            <code>literal type</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="isConcurrencyLimitExceeded"></a>
                    <span class="name">
                        <span class="modifier">Private</span>
                        <span ><b>isConcurrencyLimitExceeded</b></span>
                        <a href="#isConcurrencyLimitExceeded"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>isConcurrencyLimitExceeded(renderingKey: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="128"
                            class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:128</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Checks for the concurrency limit</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>renderingKey</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                    </div>
                    <div class="io-description">
                        <p>true if rendering this request would exceed the concurrency limit</p>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="log"></a>
                    <span class="name">
                        <span class="modifier">Protected</span>
                        <span ><b>log</b></span>
                        <a href="#log"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>log(message: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, debug)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="269"
                            class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:269</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                    <td>Default value</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>message</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>

                                    <td>
                                    </td>

                                </tr>
                                <tr>
                                    <td>debug</td>
                                    <td>
                                    </td>

                                    <td>
                                        No
                                    </td>

                                    <td>
                                        <code>true</code>
                                    </td>

                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="renderResponse"></a>
                    <span class="name">
                        <span class="modifier">Protected</span>
                        <span ><b>renderResponse</b></span>
                        <a href="#renderResponse"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>renderResponse(filePath: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, options: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>, callback: <a href="../undefineds/SsrCallbackFn.html" target="_self">SsrCallbackFn</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="202"
                            class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:202</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Handles the request and invokes the given <code>callback</code> with the result html / error.</p>
<p>The result might be ether:</p>
<ul>
<li>a CSR fallback with a basic <code>index.html</code> content</li>
<li>a result rendered by the original Angular Universal express engine</li>
<li>a result from the in-memory cache (which was previously rendered by Angular Universal express engine).</li>
</ul>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>filePath</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>options</td>
                                    <td>
                                                <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>callback</td>
                                    <td>
                                                <code><a href="../miscellaneous/typealiases.html#SsrCallbackFn" target="_self" >SsrCallbackFn</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="returnCachedRender"></a>
                    <span class="name">
                        <span class="modifier">Protected</span>
                        <span ><b>returnCachedRender</b></span>
                        <a href="#returnCachedRender"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>returnCachedRender(request: Request, callback: <a href="../undefineds/SsrCallbackFn.html" target="_self">SsrCallbackFn</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="174"
                            class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:174</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>If there is an available cached response for this rendering key,
it invokes the given render callback with the response and returns true.</p>
<p>Otherwise, it returns false.</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>request</td>
                                    <td>
                                            <code>Request</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>callback</td>
                                    <td>
                                                <code><a href="../miscellaneous/typealiases.html#SsrCallbackFn" target="_self" >SsrCallbackFn</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="shouldRender"></a>
                    <span class="name">
                        <span class="modifier">Protected</span>
                        <span ><b>shouldRender</b></span>
                        <a href="#shouldRender"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>shouldRender(request: Request)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="99"
                            class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:99</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>When returns true, the server side rendering should be performed.
When returns false, the CSR fallback should be returned.</p>
<p>We should not render, when there is already
a pending rendering for the same rendering key
(unless the <code>reuseCurrentRendering</code> config option is enabled)
OR when the concurrency limit is exceeded.</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>request</td>
                                    <td>
                                            <code>Request</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="shouldTimeout"></a>
                    <span class="name">
                        <span class="modifier">Protected</span>
                        <span ><b>shouldTimeout</b></span>
                        <a href="#shouldTimeout"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>shouldTimeout(request: Request)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="149"
                            class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:149</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Returns true, when the <code>timeout</code> option has been configured to non-zero value OR
when the rendering strategy for the given request is ALWAYS_SSR.
Otherwise, it returns false.</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>request</td>
                                    <td>
                                            <code>Request</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="startRender"></a>
                    <span class="name">
                        <span class="modifier">Private</span>
                        <span ><b>startRender</b></span>
                        <a href="#startRender"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>startRender(undefined: literal type)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="355"
                            class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:355</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Delegates the render to the original <em>Angular Universal express engine</em>.</p>
<p>There is no way to abort the running render of Angular Universal.
So if the render doesn&#39;t complete in the configured <code>maxRenderTime</code>,
we just consider the render task as hanging (note: it&#39;s a potential memory leak!).
Later on, even if the render completes somewhen in the future, we will ignore
its result.</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                            <code>literal type</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>





            <section>
    <h3 id="accessors">
        Accessors
    </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="engineInstance"></a>
                        <span class="name"><b>engineInstance</b><a href="#engineInstance"><span class="icon ion-ios-link"></span></a></span>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <span class="accessor"><b>get</b><code>engineInstance()</code></span>
                    </td>
                </tr>
                            <tr>
                                <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="55" class="link-to-prism">core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts:55</a></div>
                                </td>
                            </tr>

            </tbody>
        </table>
</section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Request, Response } from &#x27;express&#x27;;
import * as fs from &#x27;fs&#x27;;
import { NgExpressEngineInstance } from &#x27;../engine-decorator/ng-express-engine-decorator&#x27;;
import { getRequestUrl } from &#x27;../util/request-url&#x27;;
import { RenderingCache } from &#x27;./rendering-cache&#x27;;
import {
  RenderingStrategy,
  SsrOptimizationOptions,
} from &#x27;./ssr-optimization-options&#x27;;

/**
 * Returns the full url for the given SSR Request.
 */
export const getDefaultRenderKey &#x3D; getRequestUrl;

export type SsrCallbackFn &#x3D; (
  /**
   * Error that might&#x27;ve occurred while rendering.
   */
  err?: Error | null | undefined,
  /**
   * HTML response.
   */
  html?: string | undefined
) &#x3D;&gt; void;

/**
 * The rendered pages are kept in memory to be served on next request. If the &#x60;cache&#x60; is set to &#x60;false&#x60;, the
 * response is evicted as soon as the first successful response is successfully returned.
 */
export class OptimizedSsrEngine {
  protected currentConcurrency &#x3D; 0;
  protected renderingCache &#x3D; new RenderingCache(this.ssrOptions);
  private templateCache &#x3D; new Map&lt;string, string&gt;();

  /**
   * When the config &#x60;reuseCurrentRendering&#x60; is enabled, we want perform
   * only one render for one rendering key and reuse the html result
   * for all the pending requests for the same rendering key.
   * Therefore we need to store the callbacks for all the pending requests
   * and invoke them with the html after the render completes.
   *
   * This Map should be used only when &#x60;reuseCurrentRendering&#x60; config is enabled.
   * It&#x27;s indexed by the rendering keys.
   */
  private renderCallbacks &#x3D; new Map&lt;string, SsrCallbackFn[]&gt;();

  get engineInstance(): NgExpressEngineInstance {
    return this.renderResponse.bind(this);
  }

  constructor(
    protected expressEngine: NgExpressEngineInstance,
    protected ssrOptions?: SsrOptimizationOptions
  ) {}

  /**
   * When SSR page can not be returned in time, we&#x27;re returning index.html of
   * the CSR application.
   * The CSR application is returned with the &quot;Cache-Control: no-store&quot; response-header. This notifies external cache systems to not use the CSR application for the subsequent request.
   */
  protected fallbackToCsr(
    response: Response,
    filePath: string,
    callback: SsrCallbackFn
  ): void {
    response.set(&#x27;Cache-Control&#x27;, &#x27;no-store&#x27;);
    callback(undefined, this.getDocument(filePath));
  }

  protected getRenderingKey(request: Request): string {
    return this.ssrOptions?.renderKeyResolver
      ? this.ssrOptions.renderKeyResolver(request)
      : getDefaultRenderKey(request);
  }

  protected getRenderingStrategy(request: Request): RenderingStrategy {
    return this.ssrOptions?.renderingStrategyResolver
      ? this.ssrOptions.renderingStrategyResolver(request)
      : RenderingStrategy.DEFAULT;
  }

  /**
   * When returns true, the server side rendering should be performed.
   * When returns false, the CSR fallback should be returned.
   *
   * We should not render, when there is already
   * a pending rendering for the same rendering key
   * (unless the &#x60;reuseCurrentRendering&#x60; config option is enabled)
   * OR when the concurrency limit is exceeded.
   */
  protected shouldRender(request: Request): boolean {
    const renderingKey &#x3D; this.getRenderingKey(request);
    const concurrencyLimitExceeded &#x3D;
      this.isConcurrencyLimitExceeded(renderingKey);
    const fallBack &#x3D;
      this.renderingCache.isRendering(renderingKey) &amp;&amp;
      !this.ssrOptions?.reuseCurrentRendering;

    if (fallBack) {
      this.log(&#x60;CSR fallback: rendering in progress (${request?.originalUrl})&#x60;);
    } else if (concurrencyLimitExceeded) {
      this.log(
        &#x60;CSR fallback: Concurrency limit exceeded (${this.ssrOptions?.concurrency})&#x60;
      );
    }

    return (
      (!fallBack &amp;&amp;
        !concurrencyLimitExceeded &amp;&amp;
        this.getRenderingStrategy(request) !&#x3D;&#x3D; RenderingStrategy.ALWAYS_CSR) ||
      this.getRenderingStrategy(request) &#x3D;&#x3D;&#x3D; RenderingStrategy.ALWAYS_SSR
    );
  }

  /**
   * Checks for the concurrency limit
   *
   * @returns true if rendering this request would exceed the concurrency limit
   */
  private isConcurrencyLimitExceeded(renderingKey: string): boolean {
    // If we can reuse a pending render for this request, we don&#x27;t take up a new concurrency slot.
    // In that case we don&#x27;t exceed the concurrency limit even if the &#x60;currentConcurrency&#x60;
    // already reaches the limit.
    if (
      this.ssrOptions?.reuseCurrentRendering &amp;&amp;
      this.renderingCache.isRendering(renderingKey)
    ) {
      return false;
    }

    return this.ssrOptions?.concurrency
      ? this.currentConcurrency &gt;&#x3D; this.ssrOptions.concurrency
      : false;
  }

  /**
   * Returns true, when the &#x60;timeout&#x60; option has been configured to non-zero value OR
   * when the rendering strategy for the given request is ALWAYS_SSR.
   * Otherwise, it returns false.
   */
  protected shouldTimeout(request: Request): boolean {
    return (
      !!this.ssrOptions?.timeout ||
      this.getRenderingStrategy(request) &#x3D;&#x3D;&#x3D; RenderingStrategy.ALWAYS_SSR
    );
  }

  /**
   * Returns the timeout value.
   *
   * In case of the rendering strategy ALWAYS_SSR, it returns the config &#x60;forcedSsrTimeout&#x60;.
   * Otherwise, it returns the config &#x60;timeout&#x60;.
   */
  protected getTimeout(request: Request): number {
    return this.getRenderingStrategy(request) &#x3D;&#x3D;&#x3D; RenderingStrategy.ALWAYS_SSR
      ? this.ssrOptions?.forcedSsrTimeout ?? 60000
      : this.ssrOptions?.timeout ?? 0;
  }

  /**
   * If there is an available cached response for this rendering key,
   * it invokes the given render callback with the response and returns true.
   *
   * Otherwise, it returns false.
   */
  protected returnCachedRender(
    request: Request,
    callback: SsrCallbackFn
  ): boolean {
    const key &#x3D; this.getRenderingKey(request);

    if (this.renderingCache.isReady(key)) {
      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
      const cached &#x3D; this.renderingCache.get(key)!;
      callback(cached.err, cached.html);

      if (!this.ssrOptions?.cache) {
        // we drop cached rendering if caching is disabled
        this.renderingCache.clear(key);
      }
      return true;
    }
    return false;
  }

  /**
   * Handles the request and invokes the given &#x60;callback&#x60; with the result html / error.
   *
   * The result might be ether:
   * - a CSR fallback with a basic &#x60;index.html&#x60; content
   * - a result rendered by the original Angular Universal express engine
   * - a result from the in-memory cache (which was previously rendered by Angular Universal express engine).
   */
  protected renderResponse(
    filePath: string,
    options: any,
    callback: SsrCallbackFn
  ): void {
    const request: Request &#x3D; options.req;
    const response: Response &#x3D; options.res || options.req.res;

    if (this.returnCachedRender(request, callback)) {
      this.log(&#x60;Render from cache (${request?.originalUrl})&#x60;);
      return;
    }
    if (!this.shouldRender(request)) {
      this.fallbackToCsr(response, filePath, callback);
      return;
    }

    let requestTimeout: NodeJS.Timeout | undefined;
    if (this.shouldTimeout(request)) {
      // establish timeout for rendering
      const timeout &#x3D; this.getTimeout(request);
      requestTimeout &#x3D; setTimeout(() &#x3D;&gt; {
        requestTimeout &#x3D; undefined;
        this.fallbackToCsr(response, filePath, callback);
        this.log(
          &#x60;SSR rendering exceeded timeout ${timeout}, fallbacking to CSR for ${request?.originalUrl}&#x60;,
          false
        );
      }, timeout);
    } else {
      // Here we respond with the fallback to CSR, but we don&#x27;t &#x60;return&#x60;.
      // We let the actual rendering task to happen in the background
      // to eventually store the rendered result in the cache.
      this.fallbackToCsr(response, filePath, callback);
    }

    const renderingKey &#x3D; this.getRenderingKey(request);
    const renderCallback: SsrCallbackFn &#x3D; (err, html): void &#x3D;&gt; {
      if (requestTimeout) {
        // if request is still waiting for render, return it
        clearTimeout(requestTimeout);
        callback(err, html);

        this.log(
          &#x60;Request is resolved with the SSR rendering result (${request?.originalUrl})&#x60;
        );

        // store the render only if caching is enabled
        if (this.ssrOptions?.cache) {
          this.renderingCache.store(renderingKey, err, html);
        } else {
          this.renderingCache.clear(renderingKey);
        }
      } else {
        // store the render for future use
        this.renderingCache.store(renderingKey, err, html);
      }
    };

    this.handleRender({
      filePath,
      options,
      renderCallback,
      request,
    });
  }

  protected log(message: string, debug &#x3D; true): void {
    if (!debug || this.ssrOptions?.debug) {
      console.log(message);
    }
  }

  /** Retrieve the document from the cache or the filesystem */
  protected getDocument(filePath: string): string {
    let doc &#x3D; this.templateCache.get(filePath);

    if (!doc) {
      // fs.readFileSync could be missing in a browser, specifically
      // in a unit tests with { node: { fs: &#x27;empty&#x27; } } webpack configuration
      doc &#x3D; fs?.readFileSync ? fs.readFileSync(filePath, &#x27;utf-8&#x27;) : &#x27;&#x27;;
      this.templateCache.set(filePath, doc);
    }

    return doc;
  }

  /**
   * Delegates the render to the original _Angular Universal express engine_.
   *
   * In case when the config &#x60;reuseCurrentRendering&#x60; is enabled and **if there is already a pending
   * render task for the same rendering key**, it doesn&#x27;t delegate a new render to Angular Universal.
   * Instead, it waits for the current rendering to complete and then reuse the result for all waiting requests.
   */
  private handleRender({
    filePath,
    options,
    renderCallback,
    request,
  }: {
    filePath: string;
    options: any;
    renderCallback: SsrCallbackFn;
    request: Request;
  }): void {
    if (!this.ssrOptions?.reuseCurrentRendering) {
      this.startRender({
        filePath,
        options,
        renderCallback,
        request,
      });
      return;
    }

    const renderingKey &#x3D; this.getRenderingKey(request);
    if (!this.renderCallbacks.has(renderingKey)) {
      this.renderCallbacks.set(renderingKey, []);
    }
    this.renderCallbacks.get(renderingKey)?.push(renderCallback);

    if (!this.renderingCache.isRendering(renderingKey)) {
      this.startRender({
        filePath,
        options,
        request,
        renderCallback: (err, html) &#x3D;&gt; {
          // Share the result of the render with all awaiting requests for the same key:

          // Note: we access the Map at the moment of the render finished (don&#x27;t store value in a local variable),
          //       because in the meantime something might have deleted the value (i.e. when &#x60;maxRenderTime&#x60; passed).
          this.renderCallbacks
            .get(renderingKey)
            ?.forEach((cb) &#x3D;&gt; cb(err, html)); // pass the shared result to all waiting rendering callbacks
          this.renderCallbacks.delete(renderingKey);
        },
      });
    }

    this.log(
      &#x60;Request is waiting for the SSR rendering to complete (${request?.originalUrl})&#x60;
    );
  }

  /**
   * Delegates the render to the original _Angular Universal express engine_.
   *
   * There is no way to abort the running render of Angular Universal.
   * So if the render doesn&#x27;t complete in the configured &#x60;maxRenderTime&#x60;,
   * we just consider the render task as hanging (note: it&#x27;s a potential memory leak!).
   * Later on, even if the render completes somewhen in the future, we will ignore
   * its result.
   */
  private startRender({
    filePath,
    options,
    renderCallback,
    request,
  }: {
    filePath: string;
    options: any;
    renderCallback: SsrCallbackFn;
    request: Request;
  }): void {
    const renderingKey &#x3D; this.getRenderingKey(request);

    // Setting the timeout for hanging renders that might not ever finish due to various reasons.
    // After the configured &#x60;maxRenderTime&#x60; passes, we consider the rendering task as hanging,
    // and release the concurrency slot and forget all callbacks waiting for the render&#x27;s result.
    let maxRenderTimeout: NodeJS.Timeout | undefined &#x3D; setTimeout(() &#x3D;&gt; {
      this.renderingCache.clear(renderingKey);
      maxRenderTimeout &#x3D; undefined;
      this.currentConcurrency--;
      if (this.ssrOptions?.reuseCurrentRendering) {
        this.renderCallbacks.delete(renderingKey);
      }
      this.log(
        &#x60;Rendering of ${request?.originalUrl} was not able to complete. This might cause memory leaks!&#x60;,
        false
      );
    }, this.ssrOptions?.maxRenderTime ?? 300000); // 300000ms &#x3D;&#x3D; 5 minutes

    this.log(&#x60;Rendering started (${request?.originalUrl})&#x60;);
    this.renderingCache.setAsRendering(renderingKey);
    this.currentConcurrency++;

    this.expressEngine(filePath, options, (err, html) &#x3D;&gt; {
      if (!maxRenderTimeout) {
        // ignore this render&#x27;s result because it exceeded maxRenderTimeout
        this.log(
          &#x60;Rendering of ${request.originalUrl} completed after the specified maxRenderTime, therefore it was ignored.&#x60;,
          false
        );
        return;
      }
      clearTimeout(maxRenderTimeout);

      this.log(&#x60;Rendering completed (${request?.originalUrl})&#x60;);
      this.currentConcurrency--;

      renderCallback(err, html);
    });
  }
}
</code></pre>
    </div>
</div>



                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'class';
            var COMPODOC_CURRENT_PAGE_URL = 'OptimizedSsrEngine.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       
       <script type="module" src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
